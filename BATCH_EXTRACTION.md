# 入力セル一括抽出ガイド

## 概要

`extract_all_cells`は、複数の動画ファイルから入力インジケータのセル画像を一括で抽出するツールです。動画のフレーム抽出から入力セルの分割まで、すべての処理を自動化します。

## 基本的な使い方

### コマンド形式

```bash
extract_all_cells <動画ディレクトリ> [出力ディレクトリ] [フレーム間隔]
```

### 引数

| 引数 | 説明 | デフォルト値 | 必須 |
|------|------|-------------|------|
| 動画ディレクトリ | 動画ファイルが格納されているディレクトリパス | - | ✓ |
| 出力ディレクトリ | 抽出したセル画像を保存するディレクトリパス | `input_cells` | |
| フレーム間隔 | フレーム抽出間隔（1=全フレーム） | `1` | |

## 使用例

### 例1: 全フレームを抽出（デフォルト）

```bash
cargo run --release --bin extract_all_cells -- sample_data
```

これにより、`sample_data`ディレクトリ内のすべての動画から、全フレームの入力セルが`input_cells`ディレクトリに抽出されます。

### 例2: 30フレームごとに抽出

```bash
cargo run --release --bin extract_all_cells -- sample_data input_cells 30
```

30フレームごと（60fpsの場合は約0.5秒ごと）に入力セルを抽出します。処理時間が大幅に短縮されます。

### 例3: カスタム出力先を指定

```bash
cargo run --release --bin extract_all_cells -- sample_data my_output_dir 60
```

60フレームごとに抽出し、結果を`my_output_dir`に保存します。

## 対応動画形式

以下の動画形式に対応しています：

- MP4 (`.mp4`)
- AVI (`.avi`)
- MOV (`.mov`)
- MKV (`.mkv`)
- WebM (`.webm`)
- FLV (`.flv`)

## 出力ディレクトリ構造

抽出されたセル画像は以下のような階層構造で保存されます：

```
input_cells/
├── video_name_01/              # 動画名ごとのディレクトリ
│   ├── frame_000000/           # フレーム番号ごとのディレクトリ
│   │   ├── row00_col00_frame_count.png  # フレームカウント（行0）
│   │   ├── row00_col01_input.png        # 入力アイコン1（行0）
│   │   ├── row00_col02_input.png        # 入力アイコン2（行0）
│   │   ├── row00_col03_input.png        # 入力アイコン3（行0）
│   │   ├── row00_col04_input.png        # 入力アイコン4（行0）
│   │   ├── row00_col05_input.png        # 入力アイコン5（行0）
│   │   ├── row00_col06_input.png        # 入力アイコン6（行0）
│   │   ├── row01_col00_frame_count.png  # フレームカウント（行1）
│   │   ├── row01_col01_input.png        # 入力アイコン1（行1）
│   │   └── ...                          # 全16行×7列=112個のセル
│   ├── frame_000030/
│   │   └── ... (112個のセル画像)
│   ├── frame_000060/
│   └── ...
├── video_name_02/
│   ├── frame_000000/
│   └── ...
└── video_name_03/
    └── ...
```

### ファイル命名規則

- **動画ディレクトリ**: 動画ファイルの拡張子を除いたファイル名
- **フレームディレクトリ**: `frame_NNNNNN` (NNNNNNは6桁のフレーム番号)
- **セル画像**: `rowXX_colYY_type.png`
  - `XX`: 行番号 (00-15)
  - `YY`: 列番号 (00-06)
  - `type`: `frame_count` または `input`

### セル画像の仕様

- **画像形式**: PNG（非圧縮、高品質）
- **画像サイズ**: 48×48ピクセル（固定）
- **カラーモード**: RGB（24ビット）
- **1フレームあたり**: 112個のセル画像
  - フレームカウント: 16個（各行に1個）
  - 入力アイコン: 96個（各行に6個）

## 処理の流れ

### ステップ1: 動画ファイルの検出

指定されたディレクトリから対応する動画ファイルを自動検出します。

```
検出された動画ファイル: 3個
  1. sample_data\input_sample_01.mp4
  2. sample_data\input_sample_02.mp4
  3. sample_data\input_sample_03.mp4
```

### ステップ2: 各動画の処理

各動画に対して以下の処理を実行します：

#### 2-1. フレーム抽出

GStreamerを使用して動画からフレームを抽出します。

```
ステップ1: フレーム抽出
  抽出間隔: 30フレームごと
  動画情報:
    解像度: 1920x1080
    FPS: 60.00
    再生時間: 39.00秒
  抽出フレーム数: 79
```

#### 2-2. 入力セル抽出

各フレームから入力インジケータ領域を抽出し、112個のセル画像に分割します。

```
ステップ2: 入力セル抽出
  入力インジケータ領域: (204, 182), サイズ: 336x768
  セルサイズ: 48x48
  進捗: 79/79 フレーム処理完了 (100.0%)
```

#### 2-3. 一時ファイルのクリーンアップ

フレーム抽出で作成された一時ファイルを削除します。

```
ステップ3: 一時ファイルのクリーンアップ
```

### ステップ3: 最終サマリー

全動画の処理結果をまとめて表示します。

```
================================================================================
=== 処理完了 ===
================================================================================
総動画数: 3
成功: 3
失敗: 0

全ての入力セルは以下に保存されました:
  input_cells
```

## パフォーマンス

### 処理時間の目安

| 条件 | 処理時間（参考値） |
|------|------------------|
| 39秒動画（60fps）、30フレーム間隔 | 約30秒 |
| 31秒動画（60fps）、30フレーム間隔 | 約25秒 |
| 14秒動画（60fps）、30フレーム間隔 | 約12秒 |
| 39秒動画（60fps）、全フレーム | 約15分 |

※ 処理時間はシステムスペックに依存します

### 抽出セル数の計算

```
抽出セル数 = (総フレーム数 ÷ フレーム間隔) × 112

例: 2,355フレーム、30フレーム間隔の場合
    (2,355 ÷ 30) × 112 = 79 × 112 = 8,848セル
```

### ディスク使用量

1セル画像のサイズは平均4-10KB程度です。

```
必要なディスク容量（概算）:
  = 抽出セル数 × 7KB

例: 8,848セル の場合
    8,848 × 7KB ≈ 62MB
```

## フレーム間隔の選び方

### 用途別の推奨設定

| 用途 | フレーム間隔 | 理由 |
|------|-------------|------|
| 入力パターン学習用データセット作成 | 1-10 | 多様な入力パターンを網羅的に収集 |
| 入力統計分析（APMなど） | 30-60 | 処理時間と精度のバランス |
| プレイ内容の概要把握 | 60-120 | 重要な場面を効率的に抽出 |
| デバッグ・動作確認 | 300-600 | 動作確認に最小限のデータで十分 |

### FPSとフレーム間隔の関係

| FPS | フレーム間隔 | 実時間間隔 |
|-----|-------------|----------|
| 60 | 1 | 約16.7ms |
| 60 | 30 | 約0.5秒 |
| 60 | 60 | 約1秒 |
| 60 | 300 | 約5秒 |
| 60 | 600 | 約10秒 |

## トラブルシューティング

### 問題: 動画ファイルが検出されない

**エラーメッセージ:**
```
警告: 動画ファイルが見つかりませんでした
```

**原因:**
- 指定したディレクトリに動画ファイルが存在しない
- ファイル拡張子が対応していない

**解決方法:**
1. ディレクトリパスが正しいか確認
2. 動画ファイルの拡張子を確認（.mp4, .avi, .mov など）
3. `ls`コマンドでファイルの存在を確認

### 問題: 入力インジケータ領域が画像範囲外

**エラーメッセージ:**
```
Error: 入力インジケータ領域が画像範囲外です
```

**原因:**
- 動画の解像度が1920x1080ではない
- 入力インジケータの位置が異なる

**解決方法:**
1. 動画の解像度を確認
2. `analyze_input_custom`で正しい座標を特定
3. `src/input_analyzer.rs`のデフォルト座標を修正

### 問題: メモリ不足

**エラーメッセージ:**
```
Error: memory allocation failed
```

**原因:**
- 大量のフレームを同時処理
- システムメモリが不足

**解決方法:**
1. フレーム間隔を大きくする（例: 1 → 30）
2. 動画を分割して個別に処理
3. システムメモリを増設

### 問題: ディスク容量不足

**エラーメッセージ:**
```
Error: No space left on device
```

**原因:**
- 抽出セル画像でディスクが満杯

**解決方法:**
1. フレーム間隔を大きくする
2. 不要な古いデータを削除
3. より大きなディスクに出力

### 問題: 処理が遅い

**症状:**
- 1フレームの処理に数秒かかる

**原因:**
- HDDへの書き込みが遅い
- CPUが低速

**解決方法:**
1. SSDに出力する
2. リリースビルドを使用（`--release`フラグ）
3. フレーム間隔を大きくする

## 高度な使い方

### 特定の動画のみを処理

処理したい動画だけを別のディレクトリにコピーしてから実行：

```bash
mkdir temp_videos
cp sample_data/input_sample_01.mp4 temp_videos/
cargo run --release --bin extract_all_cells -- temp_videos
```

### 処理の並列化

複数の動画を並列処理する場合は、シェルスクリプトを使用：

```bash
# PowerShell
$videos = Get-ChildItem sample_data\*.mp4
foreach ($video in $videos) {
    Start-Job -ScriptBlock {
        cargo run --release --bin extract_all_cells -- (Split-Path $using:video) "input_cells_$($using:video.BaseName)" 30
    }
}
```

### 処理の自動化

cron（Linux）またはタスクスケジューラ（Windows）で定期実行：

```bash
# Linux cron
0 2 * * * cd /path/to/input_analyzer && cargo run --release --bin extract_all_cells -- /path/to/videos
```

## ベストプラクティス

### 1. 段階的な処理

まず小さいフレーム間隔でテスト、問題なければ本番処理：

```bash
# テスト（300フレーム間隔）
cargo run --release --bin extract_all_cells -- sample_data test_output 300

# 確認
ls test_output/*/

# 本番（30フレーム間隔）
cargo run --release --bin extract_all_cells -- sample_data input_cells 30
```

### 2. ディスク容量の事前確認

```bash
# 必要容量の計算
# 総フレーム数 × 112セル × 7KB ÷ フレーム間隔

# ディスク空き容量の確認
df -h .
```

### 3. ログの保存

処理ログを保存しておくと後で確認できます：

```bash
cargo run --release --bin extract_all_cells -- sample_data input_cells 30 2>&1 | tee extraction_log.txt
```

### 4. リリースビルドの使用

デバッグビルドは遅いので、必ずリリースビルドを使用：

```bash
cargo run --release --bin extract_all_cells -- sample_data
```

## 次のステップ

抽出したセル画像を使って以下の処理を行うことができます：

### 1. データセットの作成

機械学習用のデータセットとして使用：

```python
# Python例
import os
from PIL import Image

def load_cells(directory):
    cells = []
    for root, dirs, files in os.walk(directory):
        for file in files:
            if file.endswith('.png'):
                img = Image.open(os.path.join(root, file))
                cells.append(img)
    return cells
```

### 2. 入力パターンの分析

統計的に入力パターンを分析：

```python
# 各入力アイコンの出現頻度
# 方向入力の分布
# ボタンの使用頻度
```

### 3. 画像認識モデルの学習

CNNなどを使って入力アイコンを自動認識：

```
Training data: input_cells/**/*.png
Model: CNN classifier
Classes: [↑, →, ↓, ←, A_1, A_2, B, W, Start, 0-99]
```

### 4. 入力履歴の再構築

認識結果から元の入力履歴を再構築：

```json
{
  "frame": 630,
  "timestamp": 10.5,
  "inputs": [
    {
      "row": 15,
      "frame_count": 3,
      "buttons": ["→", "A_1"]
    }
  ]
}
```

## まとめ

`extract_all_cells`は、ゲーム動画から大量の入力セル画像を効率的に抽出するツールです。

主な特徴：
- ✅ 複数動画の一括処理
- ✅ 柔軟なフレーム間隔設定
- ✅ 階層的に整理された出力
- ✅ 自動クリーンアップ
- ✅ 詳細な進捗表示

これにより、手動での画像抽出作業を完全に自動化し、大規模なデータセット作成や入力分析が可能になります。