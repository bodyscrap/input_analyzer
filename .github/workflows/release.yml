name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
      
      - name: Install GStreamer
        run: |
          choco install gstreamer gstreamer-devel --version=1.24.5 -y
          echo "C:\gstreamer\1.0\msvc_x86_64\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
          
      - name: Cache cargo registry
        uses: actions/cache@v3
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
          
      - name: Cache cargo index
        uses: actions/cache@v3
        with:
          path: ~/.cargo/git
          key: ${{ runner.os }}-cargo-index-${{ hashFiles('**/Cargo.lock') }}
          
      - name: Cache cargo build
        uses: actions/cache@v3
        with:
          path: target
          key: ${{ runner.os }}-cargo-build-target-${{ hashFiles('**/Cargo.lock') }}
      
      - name: Build GUI application
        run: cargo build --release --features gui,ml --bin input_editor_gui
        env:
          GSTREAMER_1_0_ROOT_MSVC_X86_64: C:\gstreamer\1.0\msvc_x86_64\
      
      - name: Create release package
        run: |
          New-Item -ItemType Directory -Path release-package
          Copy-Item target\release\input_editor_gui.exe release-package\
          Copy-Item INSTALL_GUIDE.md release-package\
          Copy-Item USER_MANUAL.md release-package\
          Copy-Item README.md release-package\
          
      - name: Create ZIP archive
        run: |
          Compress-Archive -Path release-package\* -DestinationPath サイバーボッツ入力履歴エディタ-${{ github.ref_name }}.zip
      
      - name: Upload release assets
        uses: softprops/action-gh-release@v1
        with:
          files: |
            サイバーボッツ入力履歴エディタ-${{ github.ref_name }}.zip
          body: |
            ## サイバーボッツ入力履歴エディタ ${{ github.ref_name }}
            
            ### インストール方法
            1. ZIPファイルをダウンロードして解凍
            2. `INSTALL_GUIDE.md` を参照してGStreamerをインストール
            3. 別途配布される機械学習モデル(`model.mpk`)をダウンロード
            4. `input_editor_gui.exe` を実行
            5. 設定メニューからモデルファイルを選択
            
            ### 同梱ファイル
            - `input_editor_gui.exe` - メインアプリケーション
            - `INSTALL_GUIDE.md` - インストール手順
            - `USER_MANUAL.md` - 操作マニュアル
            - `README.md` - プロジェクト概要
            
            ### 注意事項
            - 機械学習モデル(`model.mpk`)は別途ダウンロードが必要です
            - GStreamer 1.24.5以降が必要です
            
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
